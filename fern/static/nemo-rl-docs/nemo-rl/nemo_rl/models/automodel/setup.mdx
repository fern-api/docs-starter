---
layout: overview
slug: nemo-rl/nemo_rl/models/automodel/setup
title: nemo_rl.models.automodel.setup
---

Setup utilities for automodel-based training in NeMo RL.

## Module Contents

### Functions

| Name | Description |
|------|-------------|
| [`setup_distributed`](#nemo_rl-models-automodel-setup-setup_distributed) | Set up distributed training environment and create FSDP2Manager. |
| [`setup_model_and_optimizer`](#nemo_rl-models-automodel-setup-setup_model_and_optimizer) | Set up model, parallelization, and optimizer. |
| [`setup_reference_model_state`](#nemo_rl-models-automodel-setup-setup_reference_model_state) | Set up reference model state dict by creating a CPU copy of the model's state dict. |
| [`validate_and_prepare_config`](#nemo_rl-models-automodel-setup-validate_and_prepare_config) | Validate configuration and prepare runtime settings. |

### Data

[`STRING_TO_DTYPE`](#nemo_rl-models-automodel-setup-STRING_TO_DTYPE)

### API

<Anchor id="nemo_rl-models-automodel-setup-setup_distributed">

<CodeBlock links={{"nemo_rl.models.policy.PolicyConfig":"/nemo-rl/nemo_rl/models/policy#nemo_rl-models-policy-PolicyConfig","nemo_rl.models.automodel.config.RuntimeConfig":"/nemo-rl/nemo_rl/models/automodel/config#nemo_rl-models-automodel-config-RuntimeConfig"}} showLineNumbers={false} wordWrap={true}>

```python
nemo_rl.models.automodel.setup.setup_distributed(
    config: nemo_rl.models.policy.PolicyConfig,
    runtime_config: nemo_rl.models.automodel.config.RuntimeConfig
) -> nemo_automodel.components.distributed.fsdp2.FSDP2Manager
```

</CodeBlock>
</Anchor>

<Indent>

Set up distributed training environment and create FSDP2Manager.

Initializes torch.distributed process group and creates an FSDP2Manager
with the appropriate parallelization and precision settings.

**Parameters:**

<ParamField path="config" type="PolicyConfig">
Policy configuration dictionary
</ParamField>

<ParamField path="runtime_config" type="RuntimeConfig">
RuntimeConfig named tuple from validate_and_prepare_config
</ParamField>

**Returns:** `FSDP2Manager`

FSDP2Manager instance with all distributed configuration


</Indent>

<Anchor id="nemo_rl-models-automodel-setup-setup_model_and_optimizer">

<CodeBlock links={{"nemo_rl.models.policy.PolicyConfig":"/nemo-rl/nemo_rl/models/policy#nemo_rl-models-policy-PolicyConfig","nemo_rl.models.automodel.config.RuntimeConfig":"/nemo-rl/nemo_rl/models/automodel/config#nemo_rl-models-automodel-config-RuntimeConfig","nemo_rl.models.automodel.config.ModelAndOptimizerState":"/nemo-rl/nemo_rl/models/automodel/config#nemo_rl-models-automodel-config-ModelAndOptimizerState"}} showLineNumbers={false} wordWrap={true}>

```python
nemo_rl.models.automodel.setup.setup_model_and_optimizer(
    config: nemo_rl.models.policy.PolicyConfig,
    tokenizer: transformers.AutoTokenizer,
    runtime_config: nemo_rl.models.automodel.config.RuntimeConfig,
    distributed_manager: nemo_automodel.components.distributed.fsdp2.FSDP2Manager,
    checkpoint_manager: typing.Any,
    is_vlm: bool = False,
    init_optimizer: bool = True,
    weights_path: typing.Optional[str] = None,
    optimizer_path: typing.Optional[str] = None
) -> nemo_rl.models.automodel.config.ModelAndOptimizerState
```

</CodeBlock>
</Anchor>

<Indent>

Set up model, parallelization, and optimizer.

Creates the model from config, applies parallelization strategies (FSDP2, TP, CP),
loads base weights, and optionally initializes optimizer and scheduler.

**Parameters:**

<ParamField path="config" type="PolicyConfig">
Policy configuration dictionary
</ParamField>

<ParamField path="tokenizer" type="AutoTokenizer">
Tokenizer for the model
</ParamField>

<ParamField path="runtime_config" type="RuntimeConfig">
RuntimeConfig named tuple from validate_and_prepare_config
</ParamField>

<ParamField path="distributed_manager" type="FSDP2Manager">
FSDP2Manager from setup_distributed
</ParamField>

<ParamField path="checkpoint_manager" type="Any">
Checkpoint manager for loading/saving weights
</ParamField>

<ParamField path="is_vlm" type="bool" default="False">
Whether this is a vision-language model
</ParamField>

<ParamField path="init_optimizer" type="bool" default="True">
Whether to initialize optimizer
</ParamField>

<ParamField path="weights_path" type="Optional[str]" default="None">
Optional path to checkpoint weights to load
</ParamField>

<ParamField path="optimizer_path" type="Optional[str]" default="None">
Optional path to optimizer state to load
</ParamField>

**Returns:** `ModelAndOptimizerState`

ModelAndOptimizerState containing model, optimizer, scheduler, and metadata


</Indent>

<Anchor id="nemo_rl-models-automodel-setup-setup_reference_model_state">

<CodeBlock showLineNumbers={false} wordWrap={true}>

```python
nemo_rl.models.automodel.setup.setup_reference_model_state(
    model: torch.nn.Module
) -> dict[str, torch.Tensor]
```

</CodeBlock>
</Anchor>

<Indent>

Set up reference model state dict by creating a CPU copy of the model's state dict.

This creates a reference copy of the model weights on CPU with pinned memory
for efficient CPU-GPU transfers. The reference model is typically used to
compute reference log probabilities during RL training.

**Parameters:**

<ParamField path="model" type="torch.nn.Module">
The model to create a reference copy from
</ParamField>

**Returns:** `dict[str, torch.Tensor]`

Dictionary mapping parameter names to CPU tensors with pinned memory


</Indent>

<Anchor id="nemo_rl-models-automodel-setup-validate_and_prepare_config">

<CodeBlock links={{"nemo_rl.models.policy.PolicyConfig":"/nemo-rl/nemo_rl/models/policy#nemo_rl-models-policy-PolicyConfig","nemo_rl.models.automodel.config.RuntimeConfig":"/nemo-rl/nemo_rl/models/automodel/config#nemo_rl-models-automodel-config-RuntimeConfig"}} showLineNumbers={false} wordWrap={true}>

```python
nemo_rl.models.automodel.setup.validate_and_prepare_config(
    config: nemo_rl.models.policy.PolicyConfig,
    processor: typing.Optional[transformers.AutoProcessor],
    rank: int
) -> nemo_rl.models.automodel.config.RuntimeConfig
```

</CodeBlock>
</Anchor>

<Indent>

Validate configuration and prepare runtime settings.

This function validates the policy configuration, sets environment variables,
determines model configuration, and returns runtime settings as a named tuple.

**Parameters:**

<ParamField path="config" type="PolicyConfig">
Policy configuration dictionary
</ParamField>

<ParamField path="processor" type="Optional[AutoProcessor]">
Optional processor for multimodal models
</ParamField>

<ParamField path="rank" type="int">
Current process rank
</ParamField>

**Returns:** `RuntimeConfig`

RuntimeConfig named tuple containing validated configuration values

**Raises:**

- `ValueError`: If configuration is invalid
- `RuntimeError`: If incompatible settings are detected


</Indent>

<Anchor id="nemo_rl-models-automodel-setup-STRING_TO_DTYPE">

<CodeBlock showLineNumbers={false} wordWrap={true}>

```python
nemo_rl.models.automodel.setup.STRING_TO_DTYPE = {'float32': torch.float32, 'bfloat16': torch.bfloat16, 'float16': torch.float16}
```

</CodeBlock>
</Anchor>

