---
layout: overview
slug: nemo-rl/nemo_rl/models/generation/vllm/utils
title: nemo_rl.models.generation.vllm.utils
---

## Module Contents

### Functions

| Name | Description |
|------|-------------|
| [`aggregate_spec_decode_counters`](#nemo_rl-models-generation-vllm-utils-aggregate_spec_decode_counters) | Aggregate speculative decoding counters from multiple workers. |
| [`compute_spec_decode_metrics`](#nemo_rl-models-generation-vllm-utils-compute_spec_decode_metrics) | Compute delta and derived metrics for speculative decoding. |
| [`format_prompt_for_vllm_generation`](#nemo_rl-models-generation-vllm-utils-format_prompt_for_vllm_generation) | Format a list of prompts for vllm generation (which requires a specific format for its own `generate` method). |

### API

<Anchor id="nemo_rl-models-generation-vllm-utils-aggregate_spec_decode_counters">

<CodeBlock showLineNumbers={false} wordWrap={true}>

```python
nemo_rl.models.generation.vllm.utils.aggregate_spec_decode_counters(
    worker_metrics: list[dict[str, float | list[float]]]
) -> dict[str | tuple[str, int], float]
```

</CodeBlock>
</Anchor>

<Indent>

Aggregate speculative decoding counters from multiple workers.

Combines spec decode metrics collected from DP leader workers into
a single aggregated counter dictionary.

**Parameters:**

<ParamField path="worker_metrics" type="list[dict[str, float | list[float]]]">
List of metric dictionaries from each worker.
Each dict maps metric names to float values or lists of floats
(for per-position metrics).
</ParamField>

**Returns:** `dict[str | tuple[str, int], float]`

Dictionary mapping metric names to their aggregated float values.


</Indent>

<Anchor id="nemo_rl-models-generation-vllm-utils-compute_spec_decode_metrics">

<CodeBlock showLineNumbers={false} wordWrap={true}>

```python
nemo_rl.models.generation.vllm.utils.compute_spec_decode_metrics(
    start_counters: dict[str | tuple[str, int], float],
    end_counters: dict[str | tuple[str, int], float]
) -> dict[str, float]
```

</CodeBlock>
</Anchor>

<Indent>

Compute delta and derived metrics for speculative decoding.

Calculates the difference between two counter snapshots and derives
acceptance rate and acceptance length metrics for logging.

**Parameters:**

<ParamField path="start_counters" type="dict[str | tuple[str, int], float]">
Counter snapshot taken before generation.
</ParamField>

<ParamField path="end_counters" type="dict[str | tuple[str, int], float]">
Counter snapshot taken after generation.
</ParamField>

**Returns:** `dict[str, float]`

Dictionary of metrics suitable for logging to wandb/tensorboard.


</Indent>

<Anchor id="nemo_rl-models-generation-vllm-utils-format_prompt_for_vllm_generation">

<CodeBlock links={{"nemo_rl.distributed.batched_data_dict.BatchedDataDict":"/nemo-rl/nemo_rl/distributed/batched_data_dict#nemo_rl-distributed-batched_data_dict-BatchedDataDict","nemo_rl.models.generation.interfaces.GenerationDatumSpec":"/nemo-rl/nemo_rl/models/generation/interfaces#nemo_rl-models-generation-interfaces-GenerationDatumSpec"}} showLineNumbers={false} wordWrap={true}>

```python
nemo_rl.models.generation.vllm.utils.format_prompt_for_vllm_generation(
    data: nemo_rl.distributed.batched_data_dict.BatchedDataDict[nemo_rl.models.generation.interfaces.GenerationDatumSpec],
    sample_idx: typing.Optional[int] = None
) -> list[dict[str, typing.Any]]
```

</CodeBlock>
</Anchor>

<Indent>

Format a list of prompts for vllm generation (which requires a specific format for its own `generate` method).

See https://docs.vllm.ai/en/v0.9.1/features/multimodal_inputs.html for prompt format for multimodal inputs.


</Indent>
