---
layout: overview
slug: nemo-rl/nemo_rl/algorithms/dpo
title: nemo_rl.algorithms.dpo
---

## Module Contents

### Classes

| Name | Description |
|------|-------------|
| [`DPOConfig`](#nemo_rl-algorithms-dpo-DPOConfig) | - |
| [`DPOSaveState`](#nemo_rl-algorithms-dpo-DPOSaveState) | - |
| [`DPOValMetrics`](#nemo_rl-algorithms-dpo-DPOValMetrics) | - |
| [`MasterConfig`](#nemo_rl-algorithms-dpo-MasterConfig) | - |

### Functions

| Name | Description |
|------|-------------|
| [`_default_dpo_save_state`](#nemo_rl-algorithms-dpo-_default_dpo_save_state) | - |
| [`add_ref_logprobs_to_data`](#nemo_rl-algorithms-dpo-add_ref_logprobs_to_data) | - |
| [`dpo_train`](#nemo_rl-algorithms-dpo-dpo_train) | - |
| [`setup`](#nemo_rl-algorithms-dpo-setup) | Main entry point for running DPO algorithm. |
| [`validate`](#nemo_rl-algorithms-dpo-validate) | - |
| [`validate_one_dataset`](#nemo_rl-algorithms-dpo-validate_one_dataset) | Run validation on one validation dataset. |

### API

<Anchor id="nemo_rl-algorithms-dpo-DPOConfig">

<CodeBlock showLineNumbers={false} wordWrap={true}>

```python
class nemo_rl.algorithms.dpo.DPOConfig
```

</CodeBlock>
</Anchor>

<Indent>

**Bases:** `typing.TypedDict`

<ParamField path="max_num_epochs" type="int">

</ParamField>

<ParamField path="max_num_steps" type="int">

</ParamField>

<ParamField path="preference_average_log_probs" type="bool">

</ParamField>

<ParamField path="preference_loss_weight" type="float">

</ParamField>

<ParamField path="reference_policy_kl_penalty" type="float">

</ParamField>

<ParamField path="seed" type="int">

</ParamField>

<ParamField path="sft_average_log_probs" type="bool">

</ParamField>

<ParamField path="sft_loss_weight" type="float">

</ParamField>

<ParamField path="val_at_end" type="bool">

</ParamField>

<ParamField path="val_at_start" type="bool">

</ParamField>

<ParamField path="val_batches" type="int">

</ParamField>

<ParamField path="val_global_batch_size" type="int">

</ParamField>

<ParamField path="val_micro_batch_size" type="int">

</ParamField>

<ParamField path="val_period" type="int">

</ParamField>

</Indent>

<Anchor id="nemo_rl-algorithms-dpo-DPOSaveState">

<CodeBlock showLineNumbers={false} wordWrap={true}>

```python
class nemo_rl.algorithms.dpo.DPOSaveState
```

</CodeBlock>
</Anchor>

<Indent>

**Bases:** `typing.TypedDict`

<ParamField path="consumed_samples" type="int">

</ParamField>

<ParamField path="epoch" type="int">

</ParamField>

<ParamField path="step" type="int">

</ParamField>

<ParamField path="total_steps" type="int">

</ParamField>

<ParamField path="total_valid_tokens" type="int">

</ParamField>

</Indent>

<Anchor id="nemo_rl-algorithms-dpo-DPOValMetrics">

<CodeBlock showLineNumbers={false} wordWrap={true}>

```python
class nemo_rl.algorithms.dpo.DPOValMetrics
```

</CodeBlock>
</Anchor>

<Indent>

**Bases:** `typing.TypedDict`

<ParamField path="accuracy" type="float">

</ParamField>

<ParamField path="global_valid_seqs" type="float">

</ParamField>

<ParamField path="global_valid_toks" type="float">

</ParamField>

<ParamField path="loss" type="float">

</ParamField>

<ParamField path="num_valid_samples" type="float">

</ParamField>

<ParamField path="preference_loss" type="float">

</ParamField>

<ParamField path="rewards_chosen_mean" type="float">

</ParamField>

<ParamField path="rewards_rejected_mean" type="float">

</ParamField>

<ParamField path="sft_loss" type="float">

</ParamField>

</Indent>

<Anchor id="nemo_rl-algorithms-dpo-MasterConfig">

<CodeBlock showLineNumbers={false} wordWrap={true}>

```python
class nemo_rl.algorithms.dpo.MasterConfig
```

</CodeBlock>
</Anchor>

<Indent>

**Bases:** `typing.TypedDict`

<ParamField path="checkpointing" type="CheckpointingConfig">

</ParamField>

<ParamField path="cluster" type="ClusterConfig">

</ParamField>

<ParamField path="data" type="DataConfig">

</ParamField>

<ParamField path="dpo" type="DPOConfig">

</ParamField>

<ParamField path="logger" type="LoggerConfig">

</ParamField>

<ParamField path="policy" type="PolicyConfig">

</ParamField>

</Indent>

<Anchor id="nemo_rl-algorithms-dpo-_default_dpo_save_state">

<CodeBlock links={{"nemo_rl.algorithms.dpo.DPOSaveState":"#nemo_rl-algorithms-dpo-DPOSaveState"}} showLineNumbers={false} wordWrap={true}>

```python
nemo_rl.algorithms.dpo._default_dpo_save_state() -> nemo_rl.algorithms.dpo.DPOSaveState
```

</CodeBlock>
</Anchor>

<Indent>


</Indent>

<Anchor id="nemo_rl-algorithms-dpo-add_ref_logprobs_to_data">

<CodeBlock showLineNumbers={false} wordWrap={true}>

```python
nemo_rl.algorithms.dpo.add_ref_logprobs_to_data(
    dataloader,
    policy,
    master_config,
    is_val = False
)
```

</CodeBlock>
</Anchor>

<Indent>


</Indent>

<Anchor id="nemo_rl-algorithms-dpo-dpo_train">

<CodeBlock links={{"nemo_rl.algorithms.dpo.DPOSaveState":"#nemo_rl-algorithms-dpo-DPOSaveState"}} showLineNumbers={false} wordWrap={true}>

```python
nemo_rl.algorithms.dpo.dpo_train(
    policy,
    train_dataloader,
    val_dataloader,
    tokenizer,
    loss_fn,
    master_config,
    logger,
    checkpointer,
    dpo_save_state: nemo_rl.algorithms.dpo.DPOSaveState
) -> None
```

</CodeBlock>
</Anchor>

<Indent>


</Indent>

<Anchor id="nemo_rl-algorithms-dpo-setup">

<CodeBlock links={{"nemo_rl.algorithms.dpo.MasterConfig":"#nemo_rl-algorithms-dpo-MasterConfig","nemo_rl.data.datasets.AllTaskProcessedDataset":"/nemo-rl/nemo_rl/data/datasets/processed_dataset#nemo_rl-data-datasets-processed_dataset-AllTaskProcessedDataset","nemo_rl.models.policy.lm_policy.Policy":"/nemo-rl/nemo_rl/models/policy/lm_policy#nemo_rl-models-policy-lm_policy-Policy","nemo_rl.distributed.virtual_cluster.RayVirtualCluster":"/nemo-rl/nemo_rl/distributed/virtual_cluster#nemo_rl-distributed-virtual_cluster-RayVirtualCluster","nemo_rl.algorithms.loss_functions.DPOLossFn":"/nemo-rl/nemo_rl/algorithms/loss_functions#nemo_rl-algorithms-loss_functions-DPOLossFn","nemo_rl.utils.logger.Logger":"/nemo-rl/nemo_rl/utils/logger#nemo_rl-utils-logger-Logger","nemo_rl.utils.checkpoint.CheckpointManager":"/nemo-rl/nemo_rl/utils/checkpoint#nemo_rl-utils-checkpoint-CheckpointManager","nemo_rl.algorithms.dpo.DPOSaveState":"#nemo_rl-algorithms-dpo-DPOSaveState"}} showLineNumbers={false} wordWrap={true}>

```python
nemo_rl.algorithms.dpo.setup(
    master_config: nemo_rl.algorithms.dpo.MasterConfig,
    tokenizer: transformers.AutoTokenizer,
    train_dataset: nemo_rl.data.datasets.AllTaskProcessedDataset,
    val_dataset: dict[str, nemo_rl.data.datasets.AllTaskProcessedDataset]
) -> tuple[nemo_rl.models.policy.lm_policy.Policy, nemo_rl.distributed.virtual_cluster.RayVirtualCluster, torchdata.stateful_dataloader.StatefulDataLoader, dict[str, torchdata.stateful_dataloader.StatefulDataLoader], nemo_rl.algorithms.loss_functions.DPOLossFn, nemo_rl.utils.logger.Logger, nemo_rl.utils.checkpoint.CheckpointManager, nemo_rl.algorithms.dpo.DPOSaveState, nemo_rl.algorithms.dpo.MasterConfig]
```

</CodeBlock>
</Anchor>

<Indent>

Main entry point for running DPO algorithm.

**Returns:** `tuple[Policy, RayVirtualCluster, StatefulDataLoader, dict[str, StatefulDataLoader], DPOLossFn, Logger, CheckpointManager, DPOSaveState, MasterConfig]`

Tuple of policy, cluster, dataloader, tokenizer, loss_fn, math_env, master_config, logger


</Indent>

<Anchor id="nemo_rl-algorithms-dpo-validate">

<CodeBlock links={{"nemo_rl.models.policy.interfaces.PolicyInterface":"/nemo-rl/nemo_rl/models/policy/interfaces#nemo_rl-models-policy-interfaces-PolicyInterface","nemo_rl.algorithms.dpo.MasterConfig":"#nemo_rl-algorithms-dpo-MasterConfig","nemo_rl.utils.logger.Logger":"/nemo-rl/nemo_rl/utils/logger#nemo_rl-utils-logger-Logger"}} showLineNumbers={false} wordWrap={true}>

```python
nemo_rl.algorithms.dpo.validate(
    policy: nemo_rl.models.policy.interfaces.PolicyInterface,
    val_dataloader: dict[str, torchdata.stateful_dataloader.StatefulDataLoader],
    tokenizer,
    loss_fn,
    step: int,
    master_config: nemo_rl.algorithms.dpo.MasterConfig,
    val_batches: int,
    val_batch_size: int,
    val_mbs: int,
    logger: nemo_rl.utils.logger.Logger
)
```

</CodeBlock>
</Anchor>

<Indent>


</Indent>

<Anchor id="nemo_rl-algorithms-dpo-validate_one_dataset">

<CodeBlock links={{"nemo_rl.models.policy.interfaces.PolicyInterface":"/nemo-rl/nemo_rl/models/policy/interfaces#nemo_rl-models-policy-interfaces-PolicyInterface","nemo_rl.algorithms.dpo.MasterConfig":"#nemo_rl-algorithms-dpo-MasterConfig"}} showLineNumbers={false} wordWrap={true}>

```python
nemo_rl.algorithms.dpo.validate_one_dataset(
    policy: nemo_rl.models.policy.interfaces.PolicyInterface,
    val_dataloader: torchdata.stateful_dataloader.StatefulDataLoader,
    loss_fn,
    step: int,
    master_config: nemo_rl.algorithms.dpo.MasterConfig,
    val_batches: int,
    val_batch_size: int,
    val_mbs: int,
    dataset_name: str
)
```

</CodeBlock>
</Anchor>

<Indent>

Run validation on one validation dataset.


</Indent>
